
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Owner Inspection — Live</title>
<meta name="referrer" content="no-referrer"/>
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self';
               img-src 'self' https: data:;
               script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;
               style-src 'self' 'unsafe-inline';
               frame-src https://drive.google.com;
               connect-src 'self' https:;
               object-src 'none'; base-uri 'self'; form-action 'none'"/>
<link rel="dns-prefetch" href="//docs.google.com">
<link rel="dns-prefetch" href="//drive.google.com">
<link rel="preconnect" href="https://docs.google.com" crossorigin>
<link rel="preconnect" href="https://drive.google.com" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" crossorigin="anonymous" defer></script>
<style>
:root{--bg:#fff;--ink:#111827;--muted:#6B7280;--line:#E5E7EB;--brand:#1F2937}
html{color-scheme: light;}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
.wrap{max-width:1200px;margin:0 auto;padding:20px}
.header{display:flex;flex-wrap:wrap;align-items:center;gap:12px;position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);padding:10px 0;z-index:10}
.h-title{font-weight:900;font-size:18px;color:var(--brand)}
.h-sub{color:var(--muted);font-size:12px}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:end}
label{font-size:12px;color:var(--muted)}
select,button{border:1px solid var(--line);border-radius:8px;padding:8px 10px;font-size:12px;background:#fff;color:#1F2937}
button{cursor:pointer}
button:focus-visible,select:focus-visible,a:focus-visible{outline:2px solid #2563EB;outline-offset:2px}
.tiles{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;margin-top:14px;list-style:none;padding:0}
.tile{display:flex;flex-direction:column;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff;text-decoration:none;color:inherit}
.tile .name{font-weight:800;margin-top:6px;text-align:center}
.pill{font-size:11px;margin-top:6px;padding:3px 7px;border-radius:999px;border:1px solid var(--line)}
.pill.ok{background:#ECFDF5;color:#065F46;border-color:#A7F3D0}
.pill.bad{background:#FEF2F2;color:#991B1B;border-color:#FECACA}
.pill.na{background:#F3F4F6;color:#374151;border-color:#E5E7EB}
.section{margin:18px 0}
.sec-title{font-weight:900;border-left:4px solid var(--brand);padding-left:10px;margin:6px 0 10px}
.gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px}
.ph{margin:0;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fff;position:relative}
.ph img,.ph iframe{width:100%;height:160px;object-fit:cover;display:block;border:0}
.ph figcaption{font-size:11px;color:#6B7280;padding:6px 8px;display:flex;justify-content:space-between;gap:6px}
.cap-left{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cap-right{color:#374151;white-space:nowrap}
.small{font-size:12px;color:var(--muted)}
.warn{color:#9B2226}
.donut{width:72px;height:72px}
.tile svg text{font-size:6px;font-weight:800;fill:#111827}
.hidden{display:none}
.skip-link{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
.skip-link:focus{position:static;width:auto;height:auto;padding:8px;border:1px solid var(--line);background:#fff;border-radius:8px}
.issues{border:1px solid var(--line);border-radius:12px;padding:12px;background:#fff}
.issues h3{margin:10px 0 6px;font-size:14px}
.issues ul{margin:0 0 8px 16px;padding:0}
.issues li{margin:2px 0}
.badge{position:absolute;top:6px;left:6px;padding:2px 6px;font-size:10px;font-weight:700;border-radius:999px;background:#B91C1C;color:#fff}
.ph.issue{border-color:#EF4444;box-shadow:0 0 0 2px #FECACA inset}
.kbd{font:11px/1.2 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#F3F4F6;border:1px solid #E5E7EB;border-bottom-width:2px;border-radius:6px;padding:2px 4px}
.progress{font-size:12px;color:#374151}
</style>
</head>
<body>
<a class="skip-link" href="#main">Skip to content</a>
<div class="wrap">
  <header class="header">
    <div>
      <h1 class="h-title" id="pageTitle">Owner Inspection — Year / Month</h1>
      <div class="h-sub small" id="summaryDate" aria-live="polite">Loading…</div>
      <div id="progress" class="progress" aria-live="polite"></div>
    </div>
    <form class="controls" id="filters" onsubmit="return false;">
      <div>
        <label id="labelYear" for="year">Year</label><br/>
        <select id="year" title="Year" aria-labelledby="labelYear" autocomplete="off"></select>
      </div>
      <div>
        <label id="labelMonth" for="month">Month</label><br/>
        <select id="month" title="Month" aria-labelledby="labelMonth" autocomplete="off"></select>
      </div>
      <div>
        <label for="inspection" class="hidden" id="inspectionLabel">Inspection</label><br/>
        <select id="inspection" title="Inspection" class="hidden" aria-labelledby="inspectionLabel" autocomplete="off"></select>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="lastBtn" type="button" title="Jump to most recent inspection" aria-keyshortcuts="L">Last</button>
        <button id="genAllBtn" type="button" title="Generate PDFs for all months to Google Drive">Generate All PDFs → Drive</button>
      </div>
      <p class="small" style="margin:0">Keyboard: <span class="kbd">L</span> = Last</p>
    </form>
  </header>

  <main id="main" tabindex="-1">
    <p id="errBox" class="small warn" role="alert" aria-live="assertive" style="margin:8px 0;"></p>

    <section aria-labelledby="secStatusHeading">
      <h2 id="secStatusHeading" class="sec-title">Section status</h2>
      <ul id="tiles" class="tiles" aria-live="polite"></ul>
    </section>

    <section class="section" aria-labelledby="photosHeading">
      <h2 id="photosHeading" class="sec-title">Photos (Selected)</h2>
      <div id="photoSections"></div>
    </section>

    <section class="section" aria-labelledby="issuesHeading">
      <h2 id="issuesHeading" class="sec-title">Issues Summary</h2>
      <div id="issuesSummary" class="issues small">Loading…</div>
    </section>
  </main>
</div>

<script type="module">
/** ====== CONFIG ====== **/
const TZ = 'America/Costa_Rica';
const DEFAULT_CSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTH18JY92PQUibhQfTwhTcJZpEEuz-NrBbe4fUWAB0lSCT2tY-X9GwIVEQhr8XCHEH08EHfq3vav1Td/pub?output=csv';
// === Google Drive integration ===
// Replace this with your deployed Apps Script Web App URL (ends with /exec)
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGbK0v6k15wxh0m48MjVy_3zqU4KbJ65kwXHU5ag2PzaBPanCvsK2eSHfQHCTXog0ZZw/exec';
// Folder ID from your link: https://drive.google.com/drive/folders/<ID>
const DRIVE_FOLDER_ID = '1xtjpkFnhmkmz5xAfQMvEEzGvWLyYIKrV';

/** ====== STATE ====== **/
let RAW_ROWS = [];
let YEARS = [];
let MONTHS_BY_YEAR = {};
let LATEST_YM = {year:undefined, month:undefined};
let CURRENT_FILTER = { y: undefined, m: undefined, idx: 'all' };

/** ====== Heuristics ====== **/
const TS_KEYS=['Timestamp','timestamp','Marca temporal','marca temporal','Fecha','fecha','Fecha y hora','fecha y hora','Date','Datetime','date','datetime'];
const META_HINTS=['email','correo','name','nombre','inspector','by who','por quién','submitted','enviado'];
const PHOTO_HINTS=['photo','photos','foto','fotos','imagen','imágenes','imagenes','image','images','picture','pictures','pic','screenshot','url','link'];
const COMMENT_HINTS=['if you answered','si respondió','si respondiste','describe','describa','coment','comment','nota','notes','observación','observaciones','por favor','explain','explique'];
const ADDRESS_HINTS=['address','direccion','dirección','property','propiedad','unit','apt','suite','street','calle','listing'];
const FRIENDLY={BR:'Bedroom',BD:'Bedroom',BA:'Bathroom',KT:'Kitchen',KI:'Kitchen',LR:'Living Room',LV:'Living Room',GQ:'General',LL:'Locks & Lights',LA:'Laundry',DR:'Dining Room',EX:'Exterior',ALL:'All Checks'};

/** ====== Utils ====== **/
const $=id=>document.getElementById(id);
const setError=msg=>{$('errBox').textContent=msg||'';};
const lower=s=>String(s||'').toLowerCase();
const stripDiacritics=s=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
const slug=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const isUrlish=s=>/\bhttps?:\/\/[\w.-]/i.test(String(s||''));
const dfmt=new Intl.DateTimeFormat(undefined,{dateStyle:'medium',timeStyle:'short',timeZone:TZ});
const mfmt=new Intl.DateTimeFormat(undefined,{month:'long'});
function monthName(m){return mfmt.format(new Date(2000,m-1,1));}
function firstVal(row,keys){if(!row||typeof row!=='object')return;for(const k of keys){if(Object.hasOwn(row,k)){const v=row[k];if(v!=null&&String(v).trim()!=='')return v;}}}
function isMetaHeader(h){const l=lower(h||'');return TS_KEYS.some(k=>l===lower(k))||META_HINTS.some(hint=>l.includes(hint));}
function isPhotoHeader(h){const s=String(h||'');const l=s.toLowerCase();const dl=stripDiacritics(s).toLowerCase();return PHOTO_HINTS.some(hint=>l.includes(hint)||dl.includes(hint));}
function isCommentOnlyHeader(h){return COMMENT_HINTS.some(hint=>lower(h||'').includes(hint));}
function sectionKeyFromHeader(h){if(!h)return null;const m=String(h).match(/\[([A-Za-z0-9_]+)\]/);if(!m)return null;return m[1].replace(/_.*/,'');}
function sanitizeCsvText(text){if(text&&text.charCodeAt(0)===0xFEFF)text=text.slice(1);return text.replace(/\r\n/g,'\n').replace(/\r/g,'\n');}
function clamp(v,min,max){return Math.max(min,Math.min(max,v));}
function toDrivePreview(u){ try{ if(!u.includes('drive.google.com')) return null; const m=u.match(/\/file\/d\/([^/]+)\//); let id=m?m[1]:null; if(!id){ const url=new URL(u); id=url.searchParams.get('id'); } return id?('https://drive.google.com/file/d/'+id+'/preview'):null; }catch{return null;} }

/** ====== Date parsing ====== **/
function parseTimestamp(row){
  const t=firstVal(row,TS_KEYS);
  if(t==null||t==='')return null;
  if(/^\d{4}-\d{2}-\d{2}/.test(t)){const d=new Date(t);return Number.isFinite(+d)?d:null;}
  const m=String(t).match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})(?:[ T](\d{1,2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){let a=+m[1],b=+m[2],y=+m[3];if(y<100)y+=2000;const month=a>12?b:a;const day=a>12?a:b;const hh=+(m[4]||'0'),mm=+(m[5]||'0'),ss=+(m[6]||'0');const d=new Date(y,month-1,day,hh,mm,ss);return Number.isFinite(+d)?d:null;}
  const d=new Date(t);return Number.isFinite(+d)?d:null;
}
function deriveYM(row){const d=parseTimestamp(row);return d?{year:d.getFullYear(),month:d.getMonth()+1}:{year:undefined,month:undefined};}

/** ====== CSV I/O ====== **/
function cacheKey(url){return `csvCache:${url}`;}
async function fetchWithTimeout(url,ms=15000){
  const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),ms);
  try{const res=await fetch(url,{cache:'no-store',mode:'cors',signal:ctrl.signal});clearTimeout(t);return res;}catch(e){clearTimeout(t);throw e;}
}
function isAllowedCsv(url){try{const u=new URL(url);if(u.protocol!=='https:')return false;return ['docs.google.com','drive.google.com'].includes(u.hostname);}catch{return false;}}
function normalizeCsvUrl(url){
  try{const u=new URL(url);
    if(u.hostname==='docs.google.com'){ if(u.pathname.includes('/spreadsheets/') && !u.searchParams.get('output')) u.searchParams.set('output','csv'); }
    if(u.hostname==='drive.google.com'){ if(!u.searchParams.get('export')) u.searchParams.set('export','download'); }
    return u.toString();
  }catch{return url;}
}
async function loadCsv(url){
  const key=cacheKey(url);
  try{const cached=sessionStorage.getItem(key);if(cached){const parsed=JSON.parse(cached);if(Array.isArray(parsed))return parsed;}}catch{}
  let res;try{res=await fetchWithTimeout(url,15000);}catch{throw new Error('Network timeout or fetch blocked fetching CSV');}
  if(!res.ok)throw new Error(`HTTP ${res.status} fetching CSV`);
  const raw=await res.text();const cleaned=sanitizeCsvText(raw);
  if(!window.Papa||!window.Papa.parse){return naiveCsvParse(cleaned);} // fallback
  return new Promise(resolve=>{
    try{
      Papa.parse(cleaned,{header:true,dynamicTyping:false,skipEmptyLines:'greedy',
        transformHeader:h=>String(h||'').normalize('NFC'),
        transform:v=>String(v??''),
        complete:(results)=>{const data=results.data||[];try{sessionStorage.setItem(key,JSON.stringify(data));}catch{} resolve(data);}});
    }catch{resolve(naiveCsvParse(cleaned));}
  });
}
function naiveCsvParse(text){
  const lines=text.split('\n').filter(l=>l!==''); if(!lines.length) return [];
  const headers=lines.shift().split(',').map(h=>h.trim());
  return lines.map(line=>{const parts=line.split(',');const o={};headers.forEach((h,i)=>o[h]=parts[i]??'');return o;});
}

/** ====== Classification ====== **/
function normalizeToken(value){let t=String(value??'').trim().toLowerCase();t=t.replace(/\s+/g,' ');return stripDiacritics(t);}
function classifyAnswer(val){
  if(val==null)return'ignore';const raw=String(val).trim();if(!raw)return'ignore';if(isUrlish(raw))return'ignore';
  const tokens=normalizeToken(raw).replace(/[^a-z]+/g,' ').trim().split(/\s+/);
  const yes=new Set(['yes','si','y','affirmative','true']); const no=new Set(['no','n','negative','false']);
  const hasYes=tokens.some(t=>yes.has(t)); const hasNo=tokens.some(t=>no.has(t));
  if(hasYes&&!hasNo)return'pass'; if(hasNo&&!hasYes)return'fail'; return'ignore';
}

/** ====== Aggregation with photo matching ====== **/
function aggregate(rows){
  const agg={sections:{},photos:{},details:{},overall:{passes:0,fails:0,total:0,rate:0}};
  let sawBracket=false; const headers=rows.length?Object.keys(rows[0]??{}):[]; const photoSeen=new Set();

  function headerTokens(h){
    const cleaned=String(h||'').replace(/\[[^\]]+\]\s*/,'')
      .replace(/\b(photos?|fotos?|imagen(?:es)?|image|images|picture|pictures|pic|screenshot|url|link)\b/gi,'')
      .replace(/[:\-–—()]/g,' ');
    return normalizeToken(cleaned).split(/\s+/).filter(Boolean);
  }
  const tokenCache=new Map();
  const tok=(h)=>{if(!tokenCache.has(h))tokenCache.set(h,headerTokens(h));return tokenCache.get(h);};
  const overlap=(a,b)=>{const sb=new Set(b);let n=0;for(const t of a) if(sb.has(t)) n++; return n;};

  function splitUrls(val){
    let s=String(val||'').replace(/\bwww\.[^\s,;|)>\]]+/gi, m => 'https://' + m);
    const out=[]; const re=/(https?:\/\/[^\s<>"')\],;|]+)(?=[\s<>"')\],;|]|$)/gi; let m;
    while((m=re.exec(s))){ let u=m[1].replace(/[)\],;.!?]+$/,'').replace(/^http:/i,'https:'); out.push(u); }
    return out;
  }

  for(const row of rows){
    const ts=parseTimestamp(row)||new Date();
    const rowQs=[];   // {key, header, tokens, pass}
    const rowPics=[]; // {key, header, tokens, urls[]}

    for(const h of headers){
      if(isMetaHeader(h)) continue;
      const val=row[h];
      const code=sectionKeyFromHeader(h); if(code) sawBracket=true;
      const key=code||'ALL';

      if(isPhotoHeader(h)){
        const urls=splitUrls(val);
        if(urls.length) rowPics.push({key,header:h,tokens:tok(h),urls});
        continue;
      }
      if(isCommentOnlyHeader(h)) continue;

      const cls=classifyAnswer(val);
      if(cls==='ignore') continue;

      (agg.sections[key]??=( {passes:0,fails:0,total:0}));
      (agg.details[key]??=[]).push({question:h,answer:String(val),pass:cls==='pass',ts});

      if(cls==='pass') agg.sections[key].passes++; else agg.sections[key].fails++;
      agg.sections[key].total++;
      rowQs.push({key,header:h,tokens:tok(h),pass:cls==='pass'});
    }

    for(const p of rowPics){
      for(const url of p.urls){
        if(photoSeen.has(url)) continue; photoSeen.add(url);
        let best=null,bestScore=0;
        for(const q of rowQs){
          const score=overlap(p.tokens,q.tokens)+(q.key===p.key?1:0);
          if(score>bestScore){bestScore=score;best=q;}
        }
        const flagged=(best && !best.pass && bestScore>0);
        (agg.photos[p.key]??=[]).push({url,ts,flagged});
      }
    }
  }

  if(!sawBracket && Object.keys(agg.photos).length){
    const merged={ALL:[]}; Object.values(agg.photos).forEach(arr=>merged.ALL.push(...arr)); agg.photos=merged;
  }

  for(const s of Object.values(agg.sections)){
    agg.overall.passes+=s.passes; agg.overall.fails+=s.fails; agg.overall.total+=s.total;
  }
  agg.overall.rate=agg.overall.total?(agg.overall.passes/agg.overall.total*100):0;
  return agg;
}

/** ====== Rendering ====== **/
function donutStrokeColor(pct){ if(pct==null) return '#9CA3AF'; if(pct>=90) return '#10B981'; if(pct>=70) return '#F59E0B'; return '#EF4444'; }
function sectionName(code){ return code==='ALL'?'All Checks':(FRIENDLY[code]?`${FRIENDLY[code]}${code==='ALL'?'':` (${code})`}`:code); }

function renderTiles(agg){
  const tiles=$('tiles'); tiles.replaceChildren();
  const keys=Object.keys(agg.sections).sort((a,b)=>{const A=agg.sections[a],B=agg.sections[b]; if(B.fails!==A.fails) return B.fails-A.fails; return a.localeCompare(b);});
  if(!keys.length){ tiles.innerHTML='<li class="small">No questions to score. Check your CSV columns.</li>'; return; }

  const frag=document.createDocumentFragment();
  for(const k of keys){
    const s=agg.sections[k];
    const rate=s.total?Math.round((s.passes/s.total)*100):null;
    const pct=rate==null?0:clamp(rate,0,100);
    const dash=`${pct},${100-pct}`;
    const center=rate===null?'No Data':`${pct}%`;
    const nameText=sectionName(k);

    const li=document.createElement('li');
    const a=document.createElement('a'); a.className='tile'; a.href='#sec-'+slug(k); a.rel='nofollow'; a.setAttribute('aria-label',`${nameText}: ${center}`);

    const svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('class','donut'); svg.setAttribute('viewBox','0 0 36 36');
    const titleEl=document.createElementNS(svgNS,'title'); titleEl.textContent=`${nameText} — ${center}`; svg.appendChild(titleEl);
    const c1=document.createElementNS(svgNS,'circle'); c1.setAttribute('cx','18'); c1.setAttribute('cy','18'); c1.setAttribute('r','15.915'); c1.setAttribute('fill','none'); c1.setAttribute('stroke','#EAEFF5'); c1.setAttribute('stroke-width','3.8'); svg.appendChild(c1);
    const c2=document.createElementNS(svgNS,'circle'); c2.setAttribute('cx','18'); c2.setAttribute('cy','18'); c2.setAttribute('r','15.915'); c2.setAttribute('fill','none'); c2.setAttribute('stroke',donutStrokeColor(pct)); c2.setAttribute('stroke-width','3.8'); c2.setAttribute('stroke-linecap','round'); c2.setAttribute('stroke-dasharray',dash); svg.appendChild(c2);
    const t=document.createElementNS(svgNS,'text'); t.setAttribute('x','18'); t.setAttribute('y','20'); t.setAttribute('text-anchor','middle'); t.textContent=center; svg.appendChild(t);

    const nameEl=document.createElement('div'); nameEl.className='name'; nameEl.textContent=nameText;
    const pill=document.createElement('div'); pill.className='pill '+(s.total===0?'na':(s.fails>0?'bad':'ok')); pill.textContent=s.total===0?'No data':(s.fails>0?`${s.fails} issue${s.fails>1?'s':''}`:'Clear'); pill.title=`${s.passes}/${s.total} passed`;

    a.append(svg,nameEl,pill); li.appendChild(a); frag.appendChild(li);
  }
  tiles.appendChild(frag);
}

function renderPhotos(agg){
  const wrap=$('photoSections'); wrap.replaceChildren();
  const keys=Object.keys(agg.photos).sort();
  if(!keys.length){ wrap.innerHTML='<div class="small">No photos detected for this period.</div>'; return; }

  const frag=document.createDocumentFragment();
  for(const k of keys){
    const id='sec-'+slug(k);
    const sec=document.createElement('section'); sec.className='section'; sec.id=id; sec.setAttribute('aria-labelledby',id+'-title');
    const title=sectionName(k);
    const h=document.createElement('h3'); h.className='sec-title'; h.id=id+'-title'; h.textContent=`${title} (${(agg.photos[k]||[]).length})`;
    const g=document.createElement('div'); g.className='gallery';

    for(const {url,ts,flagged} of (agg.photos[k]||[])){
      const fig=document.createElement('figure'); fig.className='ph'+(flagged?' issue':'');
      if(flagged){ const b=document.createElement('span'); b.className='badge'; b.textContent='Issue'; fig.appendChild(b); }
      const img=document.createElement('img'); img.alt=`${title} photo`; img.loading='lazy'; img.referrerPolicy='no-referrer'; img.decoding='async'; img.src=url;
      img.onerror=()=>{
        const prev=toDrivePreview(url);
        if(prev){ const ifr=document.createElement('iframe'); ifr.loading='lazy'; ifr.referrerPolicy='no-referrer'; ifr.src=prev; ifr.title='Google Drive preview'; ifr.setAttribute('sandbox','allow-scripts allow-same-origin'); fig.appendChild(ifr); img.remove(); }
        else{ const a=document.createElement('a'); a.href=url; a.target='_blank'; a.rel='noopener'; a.textContent='Open Photo'; img.replaceWith(a); }
      };
      const cap=document.createElement('figcaption');
      const left=document.createElement('span'); left.className='cap-left'; left.textContent=title+(flagged?' — Issue':'');
      const right=document.createElement('span'); right.className='cap-right'; right.textContent=dfmt.format(ts);
      cap.append(left,right); fig.append(img,cap); g.appendChild(fig);
    }

    sec.append(h,g); frag.appendChild(sec);
  }
  wrap.appendChild(frag);
}

function renderIssuesSummary(agg){
  const wrap=$('issuesSummary'); wrap.replaceChildren();
  const cats=Object.keys(agg.details||{}).filter(k=>(agg.details[k]||[]).some(item=>!item.pass));
  if(!cats.length){ wrap.textContent='No issues found — all checks passed.'; return; }
  cats.sort();
  const frag=document.createDocumentFragment();
  for(const k of cats){
    const sec=document.createElement('div');
    const title=document.createElement('h3'); title.textContent=sectionName(k); sec.appendChild(title);
    const list=document.createElement('ul');
    const grouped=new Map();
    for(const item of (agg.details[k]||[])){ if(item.pass) continue; const key=`${item.question} — ${String(item.answer)}`; grouped.set(key,(grouped.get(key)||0)+1); }
    for(const [txt,count] of grouped){ const li=document.createElement('li'); li.textContent=count>1?`${txt} (x${count})`:txt; list.appendChild(li); }
    sec.appendChild(list); frag.appendChild(sec);
  }
  wrap.appendChild(frag);
}

/** ====== Indexing, selectors, apply ====== **/
function deriveAddress(rows){
  if(!rows||!rows.length) return '';
  const headers=Object.keys(rows[0]||{}); let addrCol=headers.find(h=>ADDRESS_HINTS.some(hint=>lower(h).includes(hint)))||'';
  if(!addrCol){ addrCol=headers.find(h=>/property|propiedad/i.test(h))||''; }
  if(addrCol){ for(const r of rows){ const v=r[addrCol]; if(v&&String(v).trim()) return String(v).trim(); } }
  return '';
}
function buildIndex(rows){
  const years=new Set(); const byYear={}; let latest={ts:0,year:undefined,month:undefined};
  for(const r of rows){ const d=parseTimestamp(r); if(!d) continue; const y=d.getFullYear(); const m=d.getMonth()+1; years.add(y); (byYear[y]??=new Set()).add(m); const t=+d; if(t>latest.ts) latest={ts:t,year:y,month:m}; }
  YEARS=Array.from(years).sort((a,b)=>a-b);
  MONTHS_BY_YEAR={}; Object.entries(byYear).forEach(([y,set])=>MONTHS_BY_YEAR[y]=Array.from(set).sort((a,b)=>a-b));
  LATEST_YM={year:latest.year,month:latest.month};
}
function monthLabel(m){return monthName(m);}

function populateSelectors(){
  const ySel=$('year'), mSel=$('month'), iSel=$('inspection'), iLbl=$('inspectionLabel');
  ySel.replaceChildren(); YEARS.forEach(y=>ySel.add(new Option(String(y),String(y))));
  if(YEARS.length) ySel.value=String(CURRENT_FILTER.y ?? YEARS[YEARS.length-1]);

  function fillMonths(y){
    mSel.replaceChildren();
    const months=(MONTHS_BY_YEAR[String(y)]||[]).sort((a,b)=>a-b);
    months.forEach(m=>mSel.add(new Option(monthLabel(m),String(m))));
    if(months.length){ const pick=CURRENT_FILTER.m ?? months[months.length-1]; mSel.value=String(pick); }
    fillInspections();
  }
  function fillInspections(){
    const y=parseInt(ySel.value,10), m=parseInt(mSel.value,10);
    const monthRows=RAW_ROWS.filter(r=>{const d=deriveYM(r);return d.year===y&&d.month===m;})
      .sort((a,b)=>(parseTimestamp(b)?.getTime()||0)-(parseTimestamp(a)?.getTime()||0));
    iSel.replaceChildren();
    if(monthRows.length<=1){ iSel.classList.add('hidden'); iLbl.classList.add('hidden'); return; }
    iSel.classList.remove('hidden'); iLbl.classList.remove('hidden');
    iSel.add(new Option('All inspections in month','all'));
    monthRows.forEach((row,idx)=>{ const d=parseTimestamp(row); const dt=d?dfmt.format(d):''; const label=idx===0?`Inspection ${idx+1} (Newest) — ${dt}`:`Inspection ${idx+1} — ${dt}`; iSel.add(new Option(label,String(idx)));});
    iSel.value=String(CURRENT_FILTER.idx ?? 'all');
  }

  fillMonths(ySel.value);
  ySel.onchange=()=>{ CURRENT_FILTER.y=+ySel.value; fillMonths(ySel.value); applySelection(true); };
  mSel.onchange=()=>{ CURRENT_FILTER.m=+mSel.value; fillInspections(); applySelection(true); };
  iSel.onchange=()=>{ CURRENT_FILTER.idx=iSel.value; applySelection(true); };
}

function applySelection(pushState=true){
  const y=parseInt($('year').value,10);
  const m=parseInt($('month').value,10);
  const iSel=$('inspection');

  let monthRows=RAW_ROWS.filter(r=>{const d=deriveYM(r);return d.year===y&&d.month===m;})
    .sort((a,b)=>(parseTimestamp(b)?.getTime()||0)-(parseTimestamp(a)?.getTime()||0));

  if(!iSel.classList.contains('hidden') && iSel.value!=='all'){
    const idx=parseInt(iSel.value,10); if(!Number.isNaN(idx)&&monthRows[idx]) monthRows=[monthRows[idx]];
  }

  const agg=aggregate(monthRows);
  const label=monthRows.length?`${monthName(m)} ${y}${(!iSel.classList.contains('hidden')&&iSel.value!=='all')?' — '+iSel.options[iSel.selectedIndex].text:''}`:'No data';
  $('summaryDate').textContent=label;

  renderTiles(agg);
  renderPhotos(agg);
  renderIssuesSummary(agg);

  if(pushState){
    const url=new URL(location.href);
    url.searchParams.set('y',String(y)); url.searchParams.set('m',String(m));
    if(!iSel.classList.contains('hidden')) url.searchParams.set('i',String(iSel.value)); else url.searchParams.delete('i');
    history.replaceState(null,'',url);
  }
}

/** ====== Build report payloads & upload ====== **/
function buildMonthRows(y,m){
  return RAW_ROWS.filter(r=>{const d=deriveYM(r);return d.year===y&&d.month===m;})
    .sort((a,b)=>(parseTimestamp(b)?.getTime()||0)-(parseTimestamp(a)?.getTime()||0));
}

function buildReportPayload(address,y,m){
  const rows=buildMonthRows(y,m);
  const agg=aggregate(rows);
  const sections=Object.keys(agg.sections).sort();
  const photos={};
  for(const k of Object.keys(agg.photos)){
    photos[k]=(agg.photos[k]||[]).map(p=>({url:p.url, flagged:!!p.flagged}));
  }
  return {
    address,
    year:y,
    month:m,
    monthLabel: `${monthName(m)} ${y}`,
    overall: agg.overall,
    sections: sections.map(k=>({ key:k, name:sectionName(k), ...agg.sections[k] })),
    issues: Object.fromEntries(Object.entries(agg.details).map(([k,arr])=>[k,arr.filter(it=>!it.pass).map(it=>({q:it.question,a:String(it.answer)}))])),
    photos
  };
}

async function postToAppsScript(payload){
  try {
    const res = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
      mode: 'cors',
    });
    try { return await res.json(); } catch { return { ok: true, cors: true }; }
  } catch (e) {
    // Fallback for GitHub Pages / CORS: fire-and-forget
    try { await fetch(APPS_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' }); } catch {}
    return { ok: true, noCors: true };
  }
}

async function generateAllReportsToDrive(){
  const prog=$('progress');
  if(!APPS_SCRIPT_URL || APPS_SCRIPT_URL.includes('PASTE_YOUR_APPS_SCRIPT')){
    alert('Please paste your Google Apps Script Web App URL into APPS_SCRIPT_URL at the top of the file.');
    return;
  }
  const address = deriveAddress(RAW_ROWS) || 'Property';
  const years = YEARS.slice();
  let total=0, done=0;
  for(const y of years){ total += (MONTHS_BY_YEAR[String(y)]||[]).length; }

  for(const y of years){
    for(const m of (MONTHS_BY_YEAR[String(y)]||[])){
      const filename = `${address} — ${y}-${String(m).padStart(2,'0')}.pdf`;
      const report = buildReportPayload(address,y,m);
      const payload = { folderId: DRIVE_FOLDER_ID, filename, report };
      prog.textContent = `Uploading ${++done}/${total}: ${filename}…`;
      try{
        await postToAppsScript(payload);
      }catch(e){
        console.error(e);
        setError(`Upload failed for ${filename}: ${e.message}`);
      }
    }
  }
  prog.textContent = `Finished generating ${total} PDF(s) to Drive.`;
}

/** ====== Boot ====== **/
function getCsvUrlFromParams(){const params=new URLSearchParams(location.search);const p=(params.get('csv')||'').trim(); if(p && isAllowedCsv(p)) return normalizeCsvUrl(p); return DEFAULT_CSV;}

async function loadAndRender(){
  setError(''); $('summaryDate').textContent='Loading…';
  const params=new URLSearchParams(location.search);
  const CSV_URL=getCsvUrlFromParams();

  try{
    const url=new URL(CSV_URL); url.searchParams.set('_ts_',Date.now());
    RAW_ROWS=await loadCsv(url.toString());
    if(!RAW_ROWS.length){ setError('No data rows found in CSV.'); }

    const addr=params.get('address')||params.get('addr');
    const address=(addr&&addr.trim())?addr.trim():deriveAddress(RAW_ROWS);
    if(address){ document.title=`Owner Inspection — ${address}`; const h1=$('pageTitle'); if(h1) h1.textContent=`Owner Inspection — ${address} — Year / Month`; }

    buildIndex(RAW_ROWS);
    const yParam=parseInt(params.get('y')||'',10), mParam=parseInt(params.get('m')||'',10), iParam=(params.get('i')||'all');
    if(Number.isFinite(yParam)) CURRENT_FILTER.y=yParam;
    if(Number.isFinite(mParam)) CURRENT_FILTER.m=mParam;
    if(iParam) CURRENT_FILTER.idx=iParam;

    populateSelectors();
    if(YEARS.length){ applySelection(false); }
    else{
      $('summaryDate').textContent='No dated rows';
      $('tiles').innerHTML='<li class="small">No timestamped responses found.</li>';
      $('photoSections').innerHTML='';
      $('issuesSummary').textContent='No issues found — all checks passed.';
    }
  }catch(err){
    console.error(err);
    setError(err.message||'Failed to load');
    $('summaryDate').textContent='Failed to load';
    $('tiles').innerHTML='<li class="small">Could not load data.</li>';
    $('photoSections').innerHTML='';
    $('issuesSummary').textContent='—';
  }
}

$('lastBtn').addEventListener('click',()=>{ if(!LATEST_YM.year||!LATEST_YM.month) return;
  const ySel=$('year'), mSel=$('month');
  ySel.value=String(LATEST_YM.year);
  mSel.replaceChildren();
  (MONTHS_BY_YEAR[String(LATEST_YM.year)]||[]).sort((a,b)=>a-b).forEach(m=>mSel.add(new Option(monthName(m),String(m))));
  mSel.value=String(LATEST_YM.month);
  $('inspection').classList.add('hidden'); $('inspectionLabel').classList.add('hidden');
  CURRENT_FILTER={y:LATEST_YM.year,m:LATEST_YM.month,idx:'all'}; applySelection();
});
$('genAllBtn').addEventListener('click', generateAllReportsToDrive);
window.addEventListener('keydown',e=>{ if(e.key && e.key.toLowerCase()==='l'){ e.preventDefault(); const btn=$('lastBtn'); if(btn) btn.click(); }});
window.addEventListener('DOMContentLoaded',loadAndRender);
</script>
</body>
</html>
